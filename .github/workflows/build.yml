name: Build Asterisk 18 for ARM (Docker Multiarch)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-arm64:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Build ARM64 with Docker
        run: |
          docker run --rm -t \
            -v $PWD:/src \
            --platform linux/arm64 \
            ubuntu:22.04 \
            bash -c "\
              apt-get update && \
              DEBIAN_FRONTEND=noninteractive apt-get install -y \
                build-essential git wget curl pkg-config \
                libncurses5-dev libssl-dev libxml2-dev libsqlite3-dev \
                libedit-dev libjansson-dev uuid-dev \
                libcurl4-openssl-dev libspeex-dev libspeexdsp-dev \
                libgsm1-dev libogg-dev libvorbis-dev libnewt-dev \
                gcc g++ make && \
              cd /src && \
              git clone -b 18 https://github.com/asterisk/asterisk asterisk-18 && \
              cd asterisk-18 && \
              ./configure && \
              make -j\$(nproc) && \
              make install DESTDIR=/src/asterisk-18-arm64/install && \
              tar czf /src/asterisk-18-arm64.tar.gz -C /src/asterisk-18-arm64/install . \
            "

      - name: Upload ARM64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: asterisk-18-arm64
          path: asterisk-18-arm64.tar.gz

  build-armhf:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Build ARMv7 (armhf) with Docker
        run: |
          docker run --rm -t \
            -v $PWD:/src \
            --platform linux/arm/v7 \
            ubuntu:22.04 \
            bash -c "\
              apt-get update && \
              DEBIAN_FRONTEND=noninteractive apt-get install -y \
                build-essential git wget curl pkg-config \
                libncurses5-dev libssl-dev libxml2-dev libsqlite3-dev \
                libedit-dev libjansson-dev uuid-dev \
                libcurl4-openssl-dev libspeex-dev libspeexdsp-dev \
                libgsm1-dev libogg-dev libvorbis-dev libnewt-dev \
                gcc g++ make && \
              cd /src && \
              git clone -b 18 https://github.com/asterisk/asterisk asterisk-18 && \
              cd asterisk-18 && \
              ./configure && \
              make -j\$(nproc) && \
              make install DESTDIR=/src/asterisk-18-armhf/install && \
              tar czf /src/asterisk-18-armhf.tar.gz -C /src/asterisk-18-armhf/install . \
            "

      - name: Upload ARMv7 artifact
        uses: actions/upload-artifact@v4
        with:
          name: asterisk-18-armhf
          path: asterisk-18-armhf.tar.gz
